<app-content-layout-view
  title="Estructura Organizacional" 
  subtitle="Define las áreas, jerarquías y puestos de trabajo.">

  <div actions>
    <app-custom-button 
      variant="primary" 
      icon="add" 
      (onClick)="openDepartmentDialog()">
      Nueva Área
    </app-custom-button>
  </div>

 @if (loading) {
    <div class="org-grid animate-fade-in">
      @for (item of [1,2,3]; track item) {
        <div class="org-card" style="pointer-events: none;">
          
          <div class="card-header">
            <div class="dept-info" style="width: 100%">
              <app-skeleton-loader variant="rectangular" width="44px" height="44px" radius="12px"></app-skeleton-loader>
              <div style="flex: 1; margin-left: 12px">
                <app-skeleton-loader variant="text" width="60%" height="20px"></app-skeleton-loader>
                <app-skeleton-loader variant="text" width="30%" height="14px"></app-skeleton-loader>
                 </div>  
            </div>
          
          </div>    

          <div class="card-stats">
            <app-skeleton-loader variant="text" width="80px"></app-skeleton-loader>
            <app-skeleton-loader variant="text" width="80px"></app-skeleton-loader>
          </div>

          <div class="card-body">
            <app-skeleton-loader variant="text" width="40%" style="margin-bottom: 1rem"></app-skeleton-loader>
            <app-skeleton-loader variant="text" width="90%"></app-skeleton-loader>
            <app-skeleton-loader variant="text" width="80%"></app-skeleton-loader>
            <app-skeleton-loader variant="text" width="60%"></app-skeleton-loader>
          </div>

          <div class="card-actions">
            <app-skeleton-loader variant="rectangular" height="36px" radius="50px"></app-skeleton-loader>
          </div>

        </div>  }
      </div>
      
    
  } @else {
    
    @if (departments.length > 0) {
      <div class="org-grid animate-fade-in">
        
        @for (dept of departments; track dept.id) { 
          <div class="org-card">
            
            <div class="card-header">
              <div class="dept-info">
                <div class="dept-icon">
                  <mat-icon>business</mat-icon>
                </div>
                <div class="dept-text">
                  <h3>{{ dept.name }}</h3>
                  <span class="dept-code">{{ dept.code || 'S/C' }}</span>
                </div>
              </div>

              <button mat-icon-button [matMenuTriggerFor]="menu">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #menu="matMenu">
                <button mat-menu-item (click)="openDepartmentDialog(dept)">
                  <mat-icon>edit</mat-icon> Editar Área
                </button>
                <button mat-menu-item (click)="deleteDepartment(dept)">
                  <mat-icon class="text-danger">delete</mat-icon> 
                  <span class="text-danger">Eliminar Área</span>
                </button>
              </mat-menu>
            </div>

            <div class="card-stats">
              <div class="stat-item" matTooltip="Empleados Activos">
                <mat-icon>group</mat-icon>
                <span>{{ dept._count?.employees || 0 }}</span>
              </div>
              <div class="stat-item" matTooltip="Cargos Definidos">
                <mat-icon>badge</mat-icon>
                <span>{{ dept._count?.positions || 0 }}</span>
              </div>
            </div>

            <div class="card-body">
              <p class="section-label">Cargos Principales</p>
              
              @if (dept.positions && dept.positions.length > 0) {
                <div class="positions-list">
                  @for (pos of dept.positions.slice(0, 3); track pos.id) {
                    <div class="position-item">
                      <span class="dot"></span>
                      <span class="pos-name">{{ pos.name }}</span>
                    </div>
                  }
                  
                  @if (dept.positions.length > 3) {
                    <div class="more-positions">
                      + {{ dept.positions.length - 3 }} cargos más...
                    </div>
                  }
                </div>
              } @else {
                <div class="empty-positions">No hay cargos definidos aún.</div>
              }
            </div>

            <div class="card-actions">
              <app-custom-button 
                variant="outline" 
                [fullWidth]="true" 
                (onClick)="openPositionsDialog(dept)">
                Gestionar Cargos
              </app-custom-button>
            </div>

          </div>
        }
      </div>
    } @else {
      
     <app-empty-state
        icon="domain_disabled"
        title="Estructura Vacía"
        description="No hay departamentos definidos aún.">
        
        <app-custom-button 
          variant="primary" 
          (onClick)="openDepartmentDialog()">
          Crear primera Área
        </app-custom-button>
        
      </app-empty-state>
    }
  }

</app-content-layout-view>