<app-content-layout-view
  title="Catálogo de Cargos" 
  subtitle="Definición de puestos y jerarquías de la organización.">

  <div actions>
    <button mat-flat-button color="primary" (click)="openDialog()">
      <mat-icon>add</mat-icon> Nuevo Cargo
    </button>
  </div>

  <div class="aesthetic-table-card animate-fade-in">
    
    <div class="table-toolbar">
      
      <mat-form-field appearance="outline" class="lego-field">
        <mat-label>Filtrar por Área</mat-label>
        <mat-select (selectionChange)="onFilterChange($event.value)">
          <mat-option [value]="undefined">Todas</mat-option>
          @for (dep of departments; track dep.id) {
            <mat-option [value]="dep.id">{{ dep.name }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="lego-field search-field">
        <mat-label>Buscar cargo...</mat-label>
        <mat-icon matPrefix>search</mat-icon>
        <input matInput (keyup)="applyFilter($event)" placeholder="Ej. Analista de Sistemas">
      </mat-form-field>

    </div>

    <table mat-table [dataSource]="dataSource" matSort>
      
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> CARGO </th>
        <td mat-cell *matCellDef="let row"> 
          <span class="font-bold text-main">{{row.name}}</span> 
        </td>
      </ng-container>

      <ng-container matColumnDef="department">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> ÁREA </th>
        <td mat-cell *matCellDef="let row">
          @if (row.department) {
    <app-status-badge [status]="row.department.name"></app-status-badge>
} @else {
    <app-status-badge status="General"></app-status-badge>
}
        </td>
      </ng-container>

      <ng-container matColumnDef="description">
        <th mat-header-cell *matHeaderCellDef> DESCRIPCIÓN </th>
        <td mat-cell *matCellDef="let row">
          <span class="text-secondary truncate-cell">
            {{row.description || '-'}}
          </span>
        </td>
      </ng-container>

      <ng-container matColumnDef="employees">
        <th mat-header-cell *matHeaderCellDef> OCUPANTES </th>
        <td mat-cell *matCellDef="let row"> 
          <span class="badge-pill count">{{ row._count?.employees || 0 }}</span> 
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="w-actions"> </th>
        <td mat-cell *matCellDef="let row">
          <div class="actions-cell">
            <button mat-icon-button class="edit-btn" (click)="openDialog(row)" matTooltip="Editar">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="deletePosition(row)" matTooltip="Eliminar">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell empty-cell" colspan="5">
         <app-empty-state
      icon="search_off"
      title="Sin resultados"
      description="No se encontraron cargos con ese filtro.">
    </app-empty-state>
        </td>
      </tr>
    </table>

    <mat-paginator [pageSizeOptions]="[10, 25]" showFirstLastButtons></mat-paginator>
  </div>

</app-content-layout-view>